name: "Conventional Commit Checker"

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write

    steps:
      - name: Check PR title follows conventional commits
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            // Conventional commit pattern
            const pattern = /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .+/;
            const isValid = pattern.test(title);

            if (!isValid) {
              // Add comment with guidance
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('üìù Conventional Commit Format')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: 'üìù **Conventional Commit Format Required**\n\n' +
                    'Your PR title doesn\'t follow our commit message format. We use [Conventional Commits](https://www.conventionalcommits.org/) for automatic versioning and changelog generation.\n\n' +
                    '**Current title:**\n```\n' + title + '\n```\n\n' +
                    '**Expected format:**\n```\n<type>(<scope>): <description>\n```\n\n' +
                    '**Examples:**\n' +
                    '- `feat: add support for filament temperature tracking`\n' +
                    '- `fix: resolve issue with color visualization`\n' +
                    '- `docs: update README with new sensor info`\n' +
                    '- `refactor: improve coordinator update logic`\n' +
                    '- `feat(sensors): add flow rate tracking`\n\n' +
                    '**Valid types:**\n' +
                    '- **feat**: New feature\n' +
                    '- **fix**: Bug fix\n' +
                    '- **docs**: Documentation changes\n' +
                    '- **style**: Code style changes (formatting, etc)\n' +
                    '- **refactor**: Code refactoring\n' +
                    '- **perf**: Performance improvements\n' +
                    '- **test**: Adding or updating tests\n' +
                    '- **chore**: Maintenance tasks\n' +
                    '- **ci**: CI/CD changes\n' +
                    '- **build**: Build system changes\n\n' +
                    '**Optional scope:**\n' +
                    'Add scope in parentheses for specific areas: `(sensors)`, `(coordinator)`, `(config)`, etc.\n\n' +
                    'Please update your PR title to follow this format! üôè'
                });
              }

              core.setFailed('PR title does not follow Conventional Commits format');
            } else {
              console.log('‚úÖ PR title follows Conventional Commits format');
            }
